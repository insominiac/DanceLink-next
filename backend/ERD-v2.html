
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dance Website - ERD v2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            page-break-before: always;
        }
        
        h1:first-of-type {
            page-break-before: avoid;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
            margin-top: 30px;
            page-break-after: avoid;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            page-break-after: avoid;
        }
        
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            page-break-inside: avoid;
        }
        
        code {
            background-color: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            page-break-inside: avoid;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        ul, ol {
            padding-left: 20px;
        }
        
        li {
            margin-bottom: 5px;
        }
        
        blockquote {
            border-left: 4px solid #3498db;
            margin: 15px 0;
            padding-left: 15px;
            color: #7f8c8d;
        }
        
        .ascii-art {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 11px;
            line-height: 1.2;
            white-space: pre;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            overflow-x: auto;
            page-break-inside: avoid;
        }
        
        strong {
            color: #2c3e50;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 15px;
            }
            
            h1, h2, h3 {
                page-break-after: avoid;
            }
            
            pre, .ascii-art {
                page-break-inside: avoid;
                font-size: 10px;
            }
            
            table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<h1 id="dance-website-erd-v2-rbac-venues-styles-unified-bookings-transactions">Dance Website - ERD v2 (RBAC, Venues, Styles, Unified Bookings, Transactions)</h1>
<h2 id="overview">Overview</h2>
<p>This ERD updates the prior schema to:
- Merge ADMINS into USERS via RBAC (no ADMINS table)
- Link INSTRUCTORS to USERS for unified accounts
- Add VENUES and reference from EVENTS via venue_id
- Normalize dance styles via mapping tables (EVENT_STYLES, CLASS_STYLES, USER_STYLES)
- Unify BOOKINGS across classes/events with duplicate-prevention
- Add TRANSACTIONS for payment/refund logging
- Remove duplicated forum tables and add ON DELETE/UPDATE rules
- Minimize JSON fields for MVP; prefer normalized columns
- Add indexes/uniques for FKs, timestamps, start_time, and style mappings
- <strong>Add timezone support: store all timestamps in UTC with timezone fields</strong>
- <strong>Add proper status/timestamp constraints and defaults</strong>
- <strong>Implement soft delete via deleted_at fields for key tables</strong>
- <strong>Optimize counters: aggregate from BOOKINGS instead of storing/updating counters</strong></p>
<h2 id="core-entities-and-relationships">Core Entities and Relationships</h2>
<pre class="codehilite"><code>┌───────────────────────────┐
│           USERS           │   (RBAC)
├───────────────────────────┤
│ id (PK)                   │
│ email (UNIQUE)            │
│ password_hash             │
│ full_name                 │
│ phone                     │
│ role ENUM('user','instructor','admin') DEFAULT 'user' │
│ bio                       │
│ profile_image             │
│ is_verified BOOLEAN DEFAULT FALSE │
│ website_url               │   -- minimized JSON: explicit columns
│ instagram_handle          │
│ timezone VARCHAR(50) DEFAULT 'UTC' │
│ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
│ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
└───────────────────────────┘
           │ 1:1?                     
           │                         
           ▼                         
┌───────────────────────────┐
│        INSTRUCTORS        │   -- linked to USERS
├───────────────────────────┤
│ id (PK)                   │
│ user_id (FK → USERS.id)   │ (UNIQUE) ensures 1 user ↔ 1 instructor profile
│ specialty                 │
│ experience_years          │
│ rating DECIMAL(3,2)       │
│ is_active                 │
│ created_at                │
│ updated_at                │
└───────────────────────────┘

┌───────────────────────────┐           ┌───────────────────────────┐
│          CLASSES          │           │          EVENTS           │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ title                     │           │ title                     │
│ description               │           │ description               │
│ level                     │           │ event_type                │
│ duration_mins             │           │ start_datetime TIMESTAMP WITH TIME ZONE │
│ max_capacity              │           │ end_datetime TIMESTAMP WITH TIME ZONE   │
│ price DECIMAL(10,2)       │           │ venue_id (FK → VENUES.id) │
│ schedule_days             │           │ price DECIMAL(10,2)       │
│ schedule_time             │           │ max_attendees             │
│ requirements              │           │ image_url                 │
│ image_url                 │           │ organizer_user_id (FK → USERS.id, NULLABLE)
│ is_active BOOLEAN DEFAULT TRUE │      │ status ENUM('draft','published','cancelled') DEFAULT 'draft' │
│ deleted_at TIMESTAMP WITH TIME ZONE NULL │      │ is_featured BOOLEAN DEFAULT FALSE │
│ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │ │ deleted_at TIMESTAMP WITH TIME ZONE NULL │
│ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
└───────────────────────────┘           │ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
           │                             │ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
           │                             └───────────────────────────┘
           ▼                             
┌───────────────────────────┐           
│      CLASS_SESSIONS       │   -- for scheduling exceptions &amp; specific sessions
├───────────────────────────┤           
│ id (PK)                   │           
│ class_id (FK → CLASSES.id)│          
│ session_date DATE         │           
│ start_time TIME           │           
│ end_time TIME             │           
│ venue_id (FK → VENUES.id, NULLABLE) │ -- override class default venue
│ instructor_id (FK → INSTRUCTORS.id, NULLABLE) │ -- override or substitute instructor
│ max_capacity INTEGER      │           -- override class default capacity
│ status ENUM('scheduled','cancelled','completed','rescheduled') DEFAULT 'scheduled' │
│ cancellation_reason TEXT  │           
│ notes TEXT                │           -- session-specific notes
│ price_override DECIMAL(10,2) │       -- override class default price
│ deleted_at TIMESTAMP WITH TIME ZONE NULL │       -- soft delete support
│ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
│ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
└───────────────────────────┘           
Constraints:
- UNIQUE (class_id, session_date, start_time)  -- prevent duplicate sessions
- CHECK (end_time &gt; start_time)  -- ensure logical time ordering
- CHECK (max_capacity &gt; 0)  -- ensure positive capacity
            │                                   │
            │                                   │
            ▼                                   ▼
┌───────────────────────────┐           ┌───────────────────────────┐
│    CLASS_INSTRUCTORS      │  (M:N)    │          VENUES           │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ class_id (FK → CLASSES.id)│          │ name                      │
│ instructor_id (FK → INSTRUCTORS.id)   │ address_line1             │
│ is_primary                │           │ address_line2             │
│ created_at                │           │ city                      │
│ updated_at                │           │ state                     │
└───────────────────────────┘           │ country                   │
                                        │ postal_code               │
                                        │ latitude DECIMAL(9,6)     │
                                        │ longitude DECIMAL(9,6)    │
                                        │ phone                     │
                                        │ website_url               │
                                        │ created_at                │
                                        │ updated_at                │
                                        └───────────────────────────┘


┌───────────────────────────┐
│         BOOKINGS          │   -- unified for class/event
├───────────────────────────┤
│ id (PK)                   │
│ user_id (FK → USERS.id)   │
│ class_id (FK → CLASSES.id, NULLABLE) │
│ event_id (FK → EVENTS.id,  NULLABLE) │
│ class_session_id (FK → CLASS_SESSIONS.id, NULLABLE) │
│ booking_datetime TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
│ status ENUM('pending','confirmed','cancelled','completed','refunded') DEFAULT 'pending' │
│ amount_paid DECIMAL(10,2) │
│ payment_method            │
│ notes                     │
│ deleted_at TIMESTAMP WITH TIME ZONE NULL │
│ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
│ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
└───────────────────────────┘
Constraints:
- CHECK (class_id IS NOT NULL OR event_id IS NOT NULL OR class_session_id IS NOT NULL)  -- at least one set
- CHECK (((class_id IS NOT NULL)::int + (event_id IS NOT NULL)::int + (class_session_id IS NOT NULL)::int) = 1)  -- exactly one of the three options
- UNIQUE (user_id, class_id) WHERE class_id IS NOT NULL     -- prevent duplicates
- UNIQUE (user_id, event_id) WHERE event_id IS NOT NULL
- UNIQUE (user_id, class_session_id) WHERE class_session_id IS NOT NULL


┌───────────────────────────┐
│       TRANSACTIONS        │   -- payment/refund logs
├───────────────────────────┤
│ id (PK)                   │
│ booking_id (FK → BOOKINGS.id, NULLABLE) │
│ user_id (FK → USERS.id)   │
│ provider ENUM('stripe','paypal','other') │
│ provider_payment_id       │
│ provider_refund_id        │ (NULLABLE)
│ type ENUM('payment','refund','adjustment') │
│ status ENUM('created','succeeded','failed','refunded','cancelled') │
│ amount                    │
│ currency                  │
│ payload TEXT              │  -- raw provider payload (minimize JSON usage)
│ created_at                │
│ updated_at                │
└───────────────────────────┘


┌───────────────────────────┐           ┌───────────────────────────┐
│        DANCE_STYLES       │           │       USER_STYLES         │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ name (UNIQUE)             │           │ user_id (FK → USERS.id)   │
│ category                  │           │ style_id (FK → DANCE_STYLES.id) │
│ is_active                 │           │ proficiency ENUM('beginner','intermediate','advanced') │
│ created_at                │           │ created_at                │
│ updated_at                │           │ updated_at                │
└───────────────────────────┘           └───────────────────────────┘

┌───────────────────────────┐           ┌───────────────────────────┐
│       CLASS_STYLES        │           │       EVENT_STYLES        │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ class_id (FK → CLASSES.id)│          │ event_id (FK → EVENTS.id) │
│ style_id (FK → DANCE_STYLES.id) │     │ style_id (FK → DANCE_STYLES.id) │
│ created_at                │           │ created_at                │
│ updated_at                │           │ updated_at                │
└───────────────────────────┘           └───────────────────────────┘
Constraints:
- UNIQUE (class_id, style_id)
- UNIQUE (event_id, style_id)
- UNIQUE (user_id, style_id) in USER_STYLES


┌───────────────────────────┐           ┌───────────────────────────┐
│        FORUM_POSTS        │           │        FORUM_REPLIES      │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ user_id (FK → USERS.id)   │           │ post_id (FK → FORUM_POSTS.id)
│ category                  │           │ user_id (FK → USERS.id)   │
│ title                     │           │ parent_id (FK → FORUM_REPLIES.id, NULLABLE)
│ content                   │           │ content                   │
│ views_count               │           │ likes_count               │
│ likes_count               │           │ is_solution               │
│ replies_count             │           │ created_at                │
│ is_pinned                 │           │ updated_at                │
│ is_locked                 │           └───────────────────────────┘
│ created_at                │
│ updated_at                │
└───────────────────────────┘

┌───────────────────────────┐           ┌───────────────────────────┐
│       NOTIFICATIONS       │           │         AUDIT_LOGS        │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ user_id (FK → USERS.id)   │           │ user_id (FK → USERS.id)   │  -- replaces admin_id
│ type                      │           │ action                    │
│ title                     │           │ table_name                │
│ message                   │           │ record_id                 │
│ is_read                   │           │ old_values TEXT           │
│ priority                  │           │ new_values TEXT           │
│ action_url                │           │ ip_address                │
│ created_at                │           │ user_agent                │
│ updated_at                │           │ created_at                │
└───────────────────────────┘           │ updated_at                │
                                        └───────────────────────────┘

┌───────────────────────────┐           ┌───────────────────────────┐
│      CONTACT_MESSAGES     │           │        TESTIMONIALS       │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ name                      │           │ user_id (FK → USERS.id)   │
│ email                     │           │ rating                    │
│ phone                     │           │ message                   │
│ subject                   │           │ is_featured               │
│ message                   │           │ created_at                │
│ is_read                   │           │ updated_at                │
│ admin_response            │
│ created_at                │
│ updated_at                │
└───────────────────────────┘

┌───────────────────────────┐           ┌───────────────────────────┐
│      PARTNER_REQUESTS     │           │       PARTNER_MATCHES     │
├───────────────────────────┤           ├───────────────────────────┤
│ id (PK)                   │           │ id (PK)                   │
│ requester_id (FK → USERS.id) │        │ user1_id (FK → USERS.id)  │
│ skill_level               │           │ user2_id (FK → USERS.id)  │
│ location_city             │           │ match_score               │
│ availability_text         │           │ status                    │
│ message                   │           │ created_at                │
│ status                    │           │ updated_at                │
│ created_at                │           └───────────────────────────┘
│ updated_at                │
└───────────────────────────┘

┌───────────────────────────┐
│        FAVORITES          │   -- polymorphic favorites system
├───────────────────────────┤
│ id (PK)                   │
│ user_id (FK → USERS.id)   │
│ entity_type ENUM('event','class','instructor','venue','user') │
│ entity_id BIGINT          │  -- references id in various tables
│ created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
│ updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() │
└───────────────────────────┘
Constraints:
- UNIQUE (user_id, entity_type, entity_id)  -- prevent duplicate favorites
- CHECK (entity_id &gt; 0)  -- ensure valid entity reference
</code></pre>

<h2 id="key-changes-vs-previous-erd">Key Changes vs Previous ERD</h2>
<ol>
<li>Removed ADMINS table. USERS has role and all admin actions reference USERS.</li>
<li>INSTRUCTORS has user_id (unique), removing duplicate identity fields from instructors; social links are simplified to explicit columns on USERS.</li>
<li>Added VENUES and referenced by EVENTS via venue_id. Removed free-text location/address from EVENTS (moved to VENUES).</li>
<li>Normalized dance styles with mapping tables: USER_STYLES, CLASS_STYLES, EVENT_STYLES.</li>
<li>Unified BOOKINGS with constraints to prevent duplicate bookings per user per class/event.</li>
<li>Added TRANSACTIONS to log payments/refunds with provider IDs and status.</li>
<li>Forum tables are singular (FORUM_POSTS, FORUM_REPLIES). All FKs include ON DELETE/UPDATE rules below.</li>
<li>Minimized JSON fields: replaced preferences/tags/social_links with normalized columns or TEXT where appropriate.</li>
<li>Added indexes and unique constraints for performance and data integrity.</li>
</ol>
<h2 id="foreign-keys-and-referential-actions">Foreign Keys and Referential Actions</h2>
<p>Unless otherwise noted, FKs use:
- ON DELETE CASCADE where child records have no meaning without parent (e.g., CLASS_INSTRUCTORS, STYLES mappings, BOOKINGS, TRANSACTIONS linked to BOOKINGS)
- ON UPDATE CASCADE for id changes (rare but safe)
- ON DELETE SET NULL where history should be retained without a parent (e.g., TRANSACTIONS.booking_id, EVENTS.organizer_user_id)</p>
<p>Examples:
- INSTRUCTORS.user_id → USERS.id ON DELETE CASCADE ON UPDATE CASCADE
- CLASS_INSTRUCTORS.class_id → CLASSES.id ON DELETE CASCADE ON UPDATE CASCADE
- CLASS_INSTRUCTORS.instructor_id → INSTRUCTORS.id ON DELETE CASCADE ON UPDATE CASCADE
- EVENTS.venue_id → VENUES.id ON DELETE RESTRICT ON UPDATE CASCADE
- BOOKINGS.user_id → USERS.id ON DELETE CASCADE ON UPDATE CASCADE
- BOOKINGS.class_id → CLASSES.id ON DELETE CASCADE ON UPDATE CASCADE
- BOOKINGS.event_id → EVENTS.id ON DELETE CASCADE ON UPDATE CASCADE
- TRANSACTIONS.booking_id → BOOKINGS.id ON DELETE SET NULL ON UPDATE CASCADE
- TRANSACTIONS.user_id → USERS.id ON DELETE CASCADE ON UPDATE CASCADE
- BOOKINGS.class_session_id → CLASS_SESSIONS.id ON DELETE CASCADE ON UPDATE CASCADE
- USER_STYLES.user_id → USERS.id ON DELETE CASCADE; style_id → DANCE_STYLES.id ON DELETE RESTRICT
- CLASS_STYLES.class_id → CLASSES.id ON DELETE CASCADE; style_id → DANCE_STYLES.id ON DELETE RESTRICT
- EVENT_STYLES.event_id → EVENTS.id ON DELETE CASCADE; style_id → DANCE_STYLES.id ON DELETE RESTRICT
- FORUM_POSTS.user_id → USERS.id ON DELETE SET NULL (optional, if you want to retain posts) or CASCADE if you prefer deletion
- FORUM_REPLIES.user_id → USERS.id ON DELETE SET NULL; post_id → FORUM_POSTS.id ON DELETE CASCADE; parent_id → FORUM_REPLIES.id ON DELETE CASCADE
- FAVORITES.user_id → USERS.id ON DELETE CASCADE ON UPDATE CASCADE
- CLASS_SESSIONS.class_id → CLASSES.id ON DELETE CASCADE ON UPDATE CASCADE
- CLASS_SESSIONS.venue_id → VENUES.id ON DELETE SET NULL ON UPDATE CASCADE
- CLASS_SESSIONS.instructor_id → INSTRUCTORS.id ON DELETE SET NULL ON UPDATE CASCADE</p>
<h2 id="indexes-and-constraints">Indexes and Constraints</h2>
<h3 id="single-column-indexes">Single Column Indexes</h3>
<ul>
<li>USERS(email) UNIQUE</li>
<li>USERS(role), USERS(created_at) INDEX</li>
<li>INSTRUCTORS(user_id) UNIQUE, INDEX</li>
<li>CLASSES(created_at), CLASSES(is_active) INDEX</li>
<li>EVENTS(venue_id) INDEX, EVENTS(status) INDEX</li>
<li>VENUES(name), VENUES(city), VENUES(country) INDEX</li>
<li>BOOKINGS(user_id) INDEX, BOOKINGS(created_at) INDEX, BOOKINGS(status) INDEX</li>
<li>BOOKINGS(class_session_id) INDEX</li>
<li>TRANSACTIONS(provider, provider_payment_id) UNIQUE (nullable provider_refund_id can be separate unique when present)</li>
<li>FORUM_POSTS(created_at), FORUM_REPLIES(created_at) INDEX</li>
</ul>
<h3 id="composite-indexes-for-query-performance">Composite Indexes for Query Performance</h3>
<p><strong>Event Location &amp; Time Queries:</strong>
- <code>CREATE INDEX idx_events_venue_datetime ON EVENTS (venue_id, start_datetime)</code>
- <code>CREATE INDEX idx_events_venue_status_datetime ON EVENTS (venue_id, status, start_datetime)</code>
- <code>CREATE INDEX idx_venues_city_country ON VENUES (city, country)</code></p>
<p><strong>City-based Event Searches (via VENUES join):</strong>
- <code>CREATE INDEX idx_venues_city_datetime ON VENUES (city, created_at)</code> -- for venue discovery
- Combined with EVENTS indexes above for efficient city + date queries</p>
<p><strong>User Activity &amp; Booking Patterns:</strong>
- <code>CREATE INDEX idx_bookings_user_datetime ON BOOKINGS (user_id, booking_datetime)</code>
- <code>CREATE INDEX idx_bookings_status_datetime ON BOOKINGS (status, created_at)</code>
- <code>CREATE INDEX idx_transactions_user_datetime ON TRANSACTIONS (user_id, created_at)</code>
- <code>CREATE INDEX idx_transactions_status_datetime ON TRANSACTIONS (status, created_at)</code></p>
<p><strong>Style-based Searches:</strong>
- <code>CREATE INDEX idx_user_styles_style_proficiency ON USER_STYLES (style_id, proficiency)</code>
- <code>CREATE INDEX idx_class_styles_style_id ON CLASS_STYLES (style_id, class_id)</code>
- <code>CREATE INDEX idx_event_styles_style_id ON EVENT_STYLES (style_id, event_id)</code></p>
<p><strong>Forum &amp; Content Queries:</strong>
- <code>CREATE INDEX idx_forum_posts_category_datetime ON FORUM_POSTS (category, created_at)</code>
- <code>CREATE INDEX idx_forum_posts_user_datetime ON FORUM_POSTS (user_id, created_at)</code>
- <code>CREATE INDEX idx_forum_replies_post_datetime ON FORUM_REPLIES (post_id, created_at)</code></p>
<p><strong>Favorites &amp; User Preferences:</strong>
- <code>CREATE INDEX idx_favorites_user_entity ON FAVORITES (user_id, entity_type)</code>
- <code>CREATE INDEX idx_favorites_entity_type_id ON FAVORITES (entity_type, entity_id)</code>
- <code>CREATE INDEX idx_favorites_user_created ON FAVORITES (user_id, created_at)</code></p>
<p><strong>Class Sessions &amp; Scheduling:</strong>
- <code>CREATE INDEX idx_class_sessions_class_date ON CLASS_SESSIONS (class_id, session_date)</code>
- <code>CREATE INDEX idx_class_sessions_date_status ON CLASS_SESSIONS (session_date, status)</code>
- <code>CREATE INDEX idx_class_sessions_venue_date ON CLASS_SESSIONS (venue_id, session_date)</code>
- <code>CREATE INDEX idx_class_sessions_instructor_date ON CLASS_SESSIONS (instructor_id, session_date)</code></p>
<h3 id="unique-constraints">Unique Constraints</h3>
<ul>
<li>USER_STYLES(user_id, style_id)</li>
<li>CLASS_STYLES(class_id, style_id)</li>
<li>EVENT_STYLES(event_id, style_id)</li>
<li>BOOKINGS(user_id, class_id) where class_id not null</li>
<li>BOOKINGS(user_id, event_id) where event_id not null</li>
<li>BOOKINGS(user_id, class_session_id) where class_session_id not null</li>
<li>FAVORITES(user_id, entity_type, entity_id)</li>
<li>CLASS_SESSIONS(class_id, session_date, start_time)</li>
</ul>
<h2 id="query-optimization-examples">Query Optimization Examples</h2>
<h3 id="efficient-city-date-queries">Efficient City + Date Queries</h3>
<p>The composite indexes enable fast execution of common search patterns:</p>
<p><strong>Example 1: Find events in a specific city on a date range</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_events_venue_datetime + idx_venues_city_country
SELECT e.*, v.name as venue_name, v.city 
FROM EVENTS e 
JOIN VENUES v ON e.venue_id = v.id 
WHERE v.city = 'New York' 
  AND e.start_datetime BETWEEN '2024-03-01' AND '2024-03-31'
  AND e.status = 'published';
</code></pre>

<p><strong>Example 2: Find available events at a specific venue</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_events_venue_status_datetime
SELECT * FROM EVENTS 
WHERE venue_id = 123 
  AND status = 'published' 
  AND start_datetime &gt; NOW()
ORDER BY start_datetime;
</code></pre>

<p><strong>Example 3: User booking history with recent first</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_bookings_user_datetime
SELECT * FROM BOOKINGS 
WHERE user_id = 456 
ORDER BY booking_datetime DESC 
LIMIT 20;
</code></pre>

<p><strong>Example 4: Find users by dance style and skill level</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_user_styles_style_proficiency
SELECT u.*, us.proficiency 
FROM USERS u 
JOIN USER_STYLES us ON u.id = us.user_id 
WHERE us.style_id = 789 
  AND us.proficiency = 'intermediate';
</code></pre>

<p><strong>Example 5: Event discovery by style</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_event_styles_style_id + idx_events_venue_datetime
SELECT e.*, v.city 
FROM EVENTS e 
JOIN EVENT_STYLES es ON e.id = es.event_id 
JOIN VENUES v ON e.venue_id = v.id 
WHERE es.style_id = 789 
  AND e.start_datetime &gt; NOW() 
  AND e.status = 'published'
ORDER BY e.start_datetime;
</code></pre>

<p><strong>Example 6: User's favorite events with venue details</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_favorites_user_entity + idx_events_venue_datetime
SELECT e.*, v.name as venue_name, v.city, f.created_at as favorited_at
FROM FAVORITES f
JOIN EVENTS e ON f.entity_id = e.id
JOIN VENUES v ON e.venue_id = v.id
WHERE f.user_id = 456 
  AND f.entity_type = 'event'
  AND e.status = 'published'
ORDER BY f.created_at DESC;
</code></pre>

<p><strong>Example 7: Find upcoming class sessions with venue and instructor details</strong></p>
<pre class="codehilite"><code class="language-sql">-- Optimized by: idx_class_sessions_date_status
SELECT 
    c.title as class_title,
    cs.session_date,
    cs.start_time,
    cs.end_time,
    cs.status,
    COALESCE(v_session.name, v_class.name) as venue_name,
    COALESCE(i_session.name, i_default.name) as instructor_name,
    cs.notes,
    COALESCE(cs.price_override, c.price) as session_price
FROM CLASS_SESSIONS cs
JOIN CLASSES c ON cs.class_id = c.id
LEFT JOIN VENUES v_session ON cs.venue_id = v_session.id  -- session-specific venue
LEFT JOIN VENUES v_class ON c.venue_id = v_class.id       -- class default venue
LEFT JOIN INSTRUCTORS i_session ON cs.instructor_id = i_session.id  -- session instructor
LEFT JOIN CLASS_INSTRUCTORS ci ON c.id = ci.class_id AND ci.is_primary = true
LEFT JOIN INSTRUCTORS i_default ON ci.instructor_id = i_default.id   -- default instructor
WHERE cs.session_date &gt;= CURRENT_DATE 
  AND cs.status IN ('scheduled', 'rescheduled')
ORDER BY cs.session_date, cs.start_time;
</code></pre>

<h3 id="index-usage-patterns">Index Usage Patterns</h3>
<ul>
<li><strong>Leading column optimization</strong>: Indexes work best when queries filter on the leftmost columns first</li>
<li><strong>Range queries</strong>: Composite indexes with datetime as the rightmost column optimize date range filters</li>
<li><strong>Covering indexes</strong>: Some indexes may include additional columns to avoid table lookups</li>
<li><strong>Maintenance</strong>: Monitor query performance and adjust indexes based on actual usage patterns</li>
</ul>
<h2 id="data-types-and-constraints-with-timezone-support">Data Types and Constraints with Timezone Support</h2>
<h3 id="timezone-handling-strategy">Timezone Handling Strategy</h3>
<ul>
<li><strong>All timestamps stored in UTC</strong> using <code>TIMESTAMP WITH TIME ZONE</code></li>
<li><strong>User timezone preferences</strong> stored in USERS.timezone field</li>
<li><strong>Event datetime fields</strong> use timezone-aware timestamps for accurate scheduling</li>
<li><strong>Application layer</strong> handles timezone conversion for display</li>
</ul>
<h3 id="common-field-types-with-constraints">Common Field Types with Constraints</h3>
<ul>
<li><strong>id</strong>: <code>BIGINT AUTO_INCREMENT PRIMARY KEY</code></li>
<li><strong>email</strong>: <code>VARCHAR(255) UNIQUE NOT NULL</code></li>
<li><strong>password_hash</strong>: <code>VARCHAR(255) NOT NULL</code></li>
<li><strong>created_at/updated_at</strong>: <code>TIMESTAMP WITH TIME ZONE DEFAULT NOW()</code> with auto-update triggers</li>
<li><strong>boolean flags</strong>: <code>BOOLEAN DEFAULT FALSE/TRUE</code> with explicit defaults</li>
<li><strong>status enums</strong>: Proper ENUM types with DEFAULT values and CHECK constraints</li>
<li><strong>price/amount fields</strong>: <code>DECIMAL(10,2)</code> for precise monetary calculations</li>
<li><strong>rating</strong>: <code>DECIMAL(3,2) DEFAULT 0.00 CHECK (rating &gt;= 0.00 AND rating &lt;= 5.00)</code></li>
<li><strong>timezone</strong>: <code>VARCHAR(50) DEFAULT 'UTC'</code> with CHECK constraint for valid timezone names</li>
</ul>
<h3 id="timestamp-constraints-and-defaults">Timestamp Constraints and Defaults</h3>
<ul>
<li><strong>USERS</strong>: </li>
<li><code>created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()</code></li>
<li><code>updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()</code> (auto-update on change)</li>
<li><strong>EVENTS</strong>: </li>
<li><code>start_datetime TIMESTAMP WITH TIME ZONE NOT NULL</code></li>
<li><code>end_datetime TIMESTAMP WITH TIME ZONE NOT NULL</code></li>
<li><code>CHECK (end_datetime &gt; start_datetime)</code> -- ensure logical datetime ordering</li>
<li><strong>BOOKINGS</strong>: </li>
<li><code>booking_datetime TIMESTAMP WITH TIME ZONE DEFAULT NOW()</code></li>
<li><code>status DEFAULT 'pending'</code></li>
<li><strong>TRANSACTIONS</strong>: </li>
<li><code>created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()</code></li>
<li><code>status DEFAULT 'created'</code></li>
</ul>
<h3 id="status-field-constraints">Status Field Constraints</h3>
<ul>
<li><strong>USERS.role</strong>: <code>ENUM('user','instructor','admin') DEFAULT 'user' NOT NULL</code></li>
<li><strong>EVENTS.status</strong>: <code>ENUM('draft','published','cancelled') DEFAULT 'draft' NOT NULL</code></li>
<li><strong>BOOKINGS.status</strong>: <code>ENUM('pending','confirmed','cancelled','completed','refunded') DEFAULT 'pending' NOT NULL</code></li>
<li><strong>TRANSACTIONS.status</strong>: <code>ENUM('created','succeeded','failed','refunded','cancelled') DEFAULT 'created' NOT NULL</code></li>
<li><strong>TRANSACTIONS.type</strong>: <code>ENUM('payment','refund','adjustment') NOT NULL</code></li>
</ul>
<h3 id="database-triggers-for-timestamp-management">Database Triggers for Timestamp Management</h3>
<ul>
<li><strong>Auto-update triggers</strong> for <code>updated_at</code> fields on all tables</li>
<li><strong>Timezone validation triggers</strong> to ensure USERS.timezone contains valid timezone identifiers</li>
<li><strong>Status transition triggers</strong> to enforce valid state changes (e.g., can't go from 'completed' to 'pending')</li>
</ul>
<h3 id="timezone-validation-examples">Timezone Validation Examples</h3>
<pre class="codehilite"><code class="language-sql">-- PostgreSQL example for timezone validation
ALTER TABLE USERS ADD CONSTRAINT valid_timezone 
CHECK (timezone IN (SELECT name FROM pg_timezone_names));

-- MySQL example (simplified)
ALTER TABLE USERS ADD CONSTRAINT valid_timezone 
CHECK (timezone REGEXP '^[A-Za-z_/]+$');
</code></pre>

<h3 id="event-datetime-constraints">Event Datetime Constraints</h3>
<ul>
<li><code>CHECK (EVENTS.end_datetime &gt; EVENTS.start_datetime)</code></li>
<li><code>CHECK (EVENTS.start_datetime &gt; NOW() - INTERVAL '1 day')</code> -- prevent scheduling far in past</li>
<li><code>CHECK (EVENTS.max_attendees &gt; 0)</code></li>
</ul>
<h3 id="soft-delete-implementation">Soft Delete Implementation</h3>
<ul>
<li><strong>deleted_at</strong>: <code>TIMESTAMP WITH TIME ZONE NULL</code> (present in CLASSES, EVENTS, CLASS_SESSIONS, BOOKINGS)</li>
<li>Tables with <code>deleted_at</code> should have an index: <code>CREATE INDEX idx_{table}_deleted_at ON {TABLE} (deleted_at)</code> </li>
<li>Query patterns should include <code>WHERE deleted_at IS NULL</code> to exclude soft-deleted records</li>
<li>Views can be created to simplify queries: <code>CREATE VIEW active_{table} AS SELECT * FROM {TABLE} WHERE deleted_at IS NULL</code></li>
</ul>
<h3 id="counter-implementation">Counter Implementation</h3>
<ul>
<li>Avoid storing and updating counters like <code>current_attendees</code> directly in tables</li>
<li>Instead, calculate counts on-demand using subqueries or aggregation:</li>
</ul>
<pre class="codehilite"><code class="language-sql">-- Example: Get event with attendee count
SELECT e.*, COUNT(b.id) as current_attendees 
FROM EVENTS e
LEFT JOIN BOOKINGS b ON e.id = b.event_id AND b.status IN ('confirmed', 'pending') AND b.deleted_at IS NULL
WHERE e.id = 123 AND e.deleted_at IS NULL
GROUP BY e.id;

-- Example: Get class sessions with attendee counts
SELECT cs.*, COUNT(b.id) as current_attendees 
FROM CLASS_SESSIONS cs
LEFT JOIN BOOKINGS b ON cs.id = b.class_session_id AND b.status IN ('confirmed', 'pending') AND b.deleted_at IS NULL
WHERE cs.class_id = 456 AND cs.deleted_at IS NULL
GROUP BY cs.id;
</code></pre>

<ul>
<li>Create materialized views or refresh counts periodically for reports that need frequent access to counts</li>
<li>Validate capacity constraints at application level: <code>COUNT(bookings) &lt;= max_attendees</code></li>
</ul>
<h2 id="notes-on-json-minimization">Notes on JSON Minimization</h2>
<ul>
<li>Replaced JSON social_links with explicit columns on USERS (website_url, instagram_handle). Add more as needed.</li>
<li>Replaced EVENT.tags JSON with normalized styles mapping; additional tagging can be added later as TAGS/TAG_MAPPINGS if needed.</li>
<li>AUDIT_LOGS uses TEXT for old/new values to avoid complex JSON; can move to JSON later as needed.</li>
</ul>
<h2 id="suggested-sql-migration-outline-rdbms-agnostic-adjust-types">Suggested SQL Migration Outline (RDBMS-agnostic, adjust types)</h2>
<ul>
<li>Add USERS.role, website_url, instagram_handle</li>
<li>Drop ADMINS; migrate admin rows into USERS with role='admin'</li>
<li>INSTRUCTORS: add user_id UNIQUE NOT NULL; backfill from existing email/user mapping; drop duplicate identity fields if present</li>
<li>Create VENUES; add EVENTS.venue_id; backfill from existing location/address; drop EVENTS.location/address</li>
<li>Create DANCE_STYLES, USER_STYLES, CLASS_STYLES, EVENT_STYLES; backfill from prior dance_style columns then drop those columns</li>
<li>Create unified BOOKINGS; migrate CLASS_BOOKINGS and EVENT_BOOKINGS into BOOKINGS; drop old tables</li>
<li>Create TRANSACTIONS; link to BOOKINGS where applicable</li>
<li>Add deleted_at to CLASSES, EVENTS, CLASS_SESSIONS, BOOKINGS (all NULL initially)</li>
<li>Remove current_attendees from EVENTS and CLASS_SESSIONS (use aggregation from BOOKINGS instead)</li>
<li>Create indexes on deleted_at fields and updated indexes per above</li>
<li>Add class_session_id to BOOKINGS and create associated constraint/index</li>
<li>Ensure ON DELETE/UPDATE rules per above</li>
</ul>
<h2 id="open-decisions">Open Decisions</h2>
<ul>
<li>FORUM_POSTS/REPLIES ON DELETE behavior: choose SET NULL vs CASCADE to align with content retention policy.</li>
<li>EVENTS.organizer_user_id optional; you may also want ORGANIZERS table linked to USERS similar to INSTRUCTORS.</li>
<li>If you need additional user preferences later, consider a USER_PREFERENCES table rather than JSON.</li>
<li>Consider whether soft delete (deleted_at) should be added to additional tables beyond the core entities.</li>
<li>Decide if any additional tables need materialized aggregation views for performance-critical counter access.</li>
</ul>
</body>
</html>
